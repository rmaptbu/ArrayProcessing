<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd"><html lang="en"><head>	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">	<title>Iterative Image Improvement Using Time Reversal Example (k-Wave)</title>	<link rel="stylesheet" href="docstyle.css" type="text/css">	<meta name="description" content="Iterative Image Improvement Using Time Reversal Example."></head><body><table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#e7ebf7">    <tr>        <td valign="baseline">            <b>k-Wave Toolbox</b>        </td>        <td valign="baseline" align="right">            <a href="example_pr_2D_tr_bandlimited_sensors.html"><img src="images/b_prev.gif" border="0" align="bottom" alt="Previous"></a>&nbsp;&nbsp;&nbsp;<a href="example_pr_2D_tr_absorption_compensation.html"><img src="images/b_next.gif" border="0" align="bottom" alt="Next"></a>        </td>    </tr></table><a name="top_of_page"></a><h2 class="title">Iterative Image Improvement Using Time Reversal Example</h2><table border="0" cellpadding="4" cellspacing="0" class="pagenavtable">    <tr>        <th>On this page&#8230;</th>    </tr>    <tr>        <td>            <p><a href="#heading1">Overview</a></p>            <p><a href="#heading2">Simulating the sensor data</a></p>                                   <p><a href="#heading3">Reconstruction using data from a line array</a></p>                                   <p><a href="#heading4">Reconstruction using data from an L-shaped array</a></p>                                   <p><a href="#heading5">Iteratively improving the image reconstruction</a></p>                               </td>    </tr></table><a name="heading1"></a><h3 class="title">Overview</h3><p>This example demonstrates how photoacoustic image reconstruction may be improved iteratively. First, the sensor data is simulated using <code><a href="kspaceFirstOrder2D.html">kspaceFirstOrder2D</a></code>. Then, in the first reconstruction, an image is formed from data recorded on a line array using time reversal. In the second, an image is formed from data recorded on an L-shaped sensor array (also using time reversal). In the final stage, this image is improved iteratively. This example builds on the <a href="example_pr_2D_tr_line_sensor.html">2D Time Reversal Reconstruction For A Line Sensor Example</a>.</p> <p>    <ul>        <li><a href="matlab:edit([getkWavePath('examples') 'example_pr_2D_TR_iterative.m']);" target="_top">open the file</a> in the MATLAB Editor</li>        <li><a href="matlab:run([getkWavePath('examples') 'example_pr_2D_TR_iterative']);" target="_top">run the file</a> in MATLAB</li>    </ul></p><p></p><p><img src="images/doc_to_top_up.gif">&nbsp;<a href="#top_of_page">Back to Top</a></p><a name="heading2"></a><h3 class="title">Simulating the sensor data</h3><p>The example begins by defining an initial pressure distribution using a pre-defined image of the word 'k-Wave'.</p><pre class="programlisting">% load an image for the initial pressure distributionp0_image = loadImage('k-Wave.png');% make it binaryp0_image = (p0_image>0);% smooth and scale the initial pressure distributionp0_magnitude = 2;p0 = p0_magnitude*smooth(kgrid, p0_image, true);% assign to the source structuresource.p0 = p0;   </pre><p>The acoustic pressure time series that would be measured at each of the sensors in an L-shaped sensor array are then simulated using <code><a href="kspaceFirstOrder2D.html">kspaceFirstOrder2D</a></code>.</p><p></p><p><img src="images/doc_to_top_up.gif">&nbsp;<a href="#top_of_page">Back to Top</a></p><a name="heading3"></a><h3 class="title">Reconstruction using data from a line array</h3><p>Part of this data - for those sensors forming a line array - is then used in a time reversal image reconstruction, just as in the <a href="example_pr_2D_tr_line_sensor.html">2D Time Reversal Reconstruction For A Line Sensor Example</a>.</p> <pre class="programlisting">% define a line array of sensorssensor.mask = zeros(Nx, Ny);sensor.mask(1, :) = 1;% assign the time reversal datasensor.time_reversal_boundary_data = sensor_data((sensor.mask(original_sensor_indices) == 1),:);% set the initial pressure to be zerosource.p0 = 0;% run the time reversal reconstructionp0_line = kspaceFirstOrder2D(kgrid, medium, source, sensor, input_args{:});</pre><p>The initial pressure distribution and image resulting from this first reconstruction are shown below:</p><p><img src="images/example_pr_2D_tr_iterative_01.png" height="420" width="561"></p><p></p><p><img src="images/doc_to_top_up.gif">&nbsp;<a href="#top_of_page">Back to Top</a></p>    <a name="heading4"></a><h3 class="title">Reconstruction using data from an L-shaped array</h3><p> The image reconstruction is then repeated using all the data measured over the L-shaped array.</p><pre class="programlisting">% extend the array to the original L-shaped formsensor.mask(:, 1) = 1;% assign the time reversal datasensor.time_reversal_boundary_data = sensor_data;% run the time reversal reconstructionp0_L = kspaceFirstOrder2D(kgrid, medium, source, sensor, input_args{:});</pre><p> The image is noticeably improved, but can be improved further still by iterating, which is described below.</p><p><img src="images/example_pr_2D_tr_iterative_02.png" height="420" width="561"></p><p></p><p><img src="images/doc_to_top_up.gif">&nbsp;<a href="#top_of_page">Back to Top</a></p>    <a name="heading5"></a><h3 class="title">Iteratively improving the image reconstruction</h3><p>Beginning with the image obtained from the L-shaped sensor, an iterative procedure is now used to improve it. This improvement is achieved by adding an additional set of (imaginary) sensors so that  the  sensor array encloses the region of interest. The missing data for these 'sensors' is then estimated using the forward model with the best image obtained so far. (In fact, a non-negativity condition is applied to the image before it is used in the forward model, as we know that in photoacoustics the initial pressure distribution cannot be negative.) The original data and the estimated data are then used together to form an image, which - at least within the region satisfying the visibility (audibility) condition - will be an improvement on the previous image. The estimate of the missing data and subsequent image reconstruction may then be iterated for even greater image improvement.</p><pre class="programlisting">Niterations = 5;for loop = 1:Niterations    % apply a non-negativity condition     source.p0 = p0_iterated.*(p0_iterated>=0);    % set the sensor mask to be just the missing sides of the box    sensor.mask = zeros(Nx, Ny);    sensor.mask(end, :) = 1;    sensor.mask(:,end) = 1;    %remove the time-reversed field so the forward model will run    sensor = rmfield(sensor,'time_reversal_boundary_data');    % estimate the data on the missing sides of the box    estimated_sensor_data = kspaceFirstOrder2D(kgrid, medium, source, sensor, input_args{:});    % define the full box array    sensor.mask = zeros(Nx, Ny);    sensor.mask(1,:) = 1;    sensor.mask(:,1) = 1;    sensor.mask(end,:) = 1;    sensor.mask(:,end) = 1;    %combine the measured data with the newly estimated data    combined_sensor_data = zeros(sum(sensor.mask(:)==1),kgrid.Nt);    combined_sensor_data(sensor_box_indices1,:) = estimated_sensor_data;    combined_sensor_data(sensor_box_indices2,:) = sensor_data;    % assign the time reversal data    sensor.time_reversal_boundary_data = combined_sensor_data;        % reset the initial pressure    source.p0 = 0;    % run the time reversal reconstruction    p0_iterated = kspaceFirstOrder2D(kgrid, medium, source, sensor, input_args{:});end</pre><p>The images from the non-iterated and iterated reconstructions using the data from the L-shaped array are shown above. Notice that within the region in which the visibility condition is satisfied (ie. the normals to every boundary in the image within this region cross the measurement surface somewhere) the image is recovered well, but outside this region there remain artefacts. That is inevitable and cannot be improved without recording more data (or perhaps making other a priori assumptions).</p><p>To show that the accuracy of the amplitudes is significantly improved, a horizontal profile through the centre of the image is shown below for the various reconstructions.</p><p><img src="images/example_pr_2D_tr_iterative_03.png" height="420" width="561"></p><p></p><p><img src="images/doc_to_top_up.gif">&nbsp;<a href="#top_of_page">Back to Top</a></p><p></p><table class="nav" summary="Navigation aid" border="0" width="100%" cellpadding="0" cellspacing="0" bgcolor="#e7ebf7">    <tr valign="top">        <td align="left" width="20"><a href="example_pr_2D_tr_bandlimited_sensors.html"><img src="images/b_prev.gif" border="0" align="bottom" alt="Previous"></a>&nbsp;</td>        <td align="left">Image Reconstruction With Bandlimited Sensors</td>        <td>&nbsp;</td>        <td align="right">Attenuation Compensation Using Time Reversal</td>        <td align="right" width="20"><a href="example_pr_2D_tr_absorption_compensation.html"><img src="images/b_next.gif" border="0" align="bottom" alt="Next"></a></td>    </tr></table><br><p class="copy">&copy; 2009-2014 Bradley Treeby and Ben Cox.</p></body></html>